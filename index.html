<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant IA Ascenseurs - Photo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .login-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 20px;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            margin: 0 auto;
        }
        .app-interface {
            display: none;
        }
        .admin-badge {
            background: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        .tech-badge {
            background: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        .camera-container {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
        }
        #cameraPreview {
            width: 100%;
            max-width: 400px;
            border: 2px solid #007bff;
            border-radius: 10px;
        }
        .photo-capture-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .captured-photo {
            max-width: 100%;
            border: 2px solid #28a745;
            border-radius: 10px;
            margin-top: 10px;
        }
        .photo-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- Écran de connexion -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                <h2>Assistant IA Ascenseurs</h2>
                <p class="text-muted">Espace Admin & Techniciens</p>
            </div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="votre@email.com" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Mot de passe</label>
                    <input type="password" class="form-control" id="password" placeholder="Votre mot de passe" required>
                </div>
                
                <button type="submit" class="btn btn-primary w-100 py-2">
                    <i class="fas fa-lock"></i> Se connecter
                </button>
            </form>
            
            <div class="mt-3 text-center">
                <small class="text-muted">
                    Test: admin@ascenseurs.com / Admin2024! ou tech1@ascenseurs.com / Tech123!
                </small>
            </div>
        </div>
    </div>

    <!-- Interface principale -->
    <div class="app-interface" id="appInterface">
        <nav class="navbar navbar-dark bg-dark">
            <div class="container">
                <span class="navbar-brand">
                    <i class="fas fa-robot"></i> Assistant IA
                    <span id="userBadge" class="ms-2"></span>
                </span>
                <div class="navbar-nav ms-auto">
                    <span class="nav-text text-light me-3">
                        <i class="fas fa-circle text-success"></i> En ligne
                    </span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Déco
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row">
                <!-- Navigation -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Navigation
                        </div>
                        <div class="list-group list-group-flush">
                            <button class="list-group-item list-group-item-action active" onclick="showSection('accueil')">
                                <i class="fas fa-home"></i> Accueil
                            </button>
                            <button class="list-group-item list-group-item-action" onclick="showSection('documents')">
                                <i class="fas fa-folder"></i> Documents IA
                            </button>
                            <button class="list-group-item list-group-item-action" onclick="showSection('diagnostic')">
                                <i class="fas fa-stethoscope"></i> Diagnostic
                            </button>
                            <button class="list-group-item list-group-item-action" id="adminNavBtn" style="display:none;" onclick="showSection('admin')">
                                <i class="fas fa-crown"></i> Administration
                            </button>
                            <!-- Option photo uniquement pour techniciens -->
                            <button class="list-group-item list-group-item-action" id="photoNavBtn" style="display:none;" onclick="showSection('photo')">
                                <i class="fas fa-camera"></i> Capture Photo
                            </button>
                        </div>
                    </div>
                    
                    <!-- Statut utilisateur -->
                    <div class="card mt-3">
                        <div class="card-body text-center p-3">
                            <h6 id="userName"></h6>
                            <div id="userRole"></div>
                        </div>
                    </div>
                </div>

                <!-- Contenu principal -->
                <div class="col-md-9">
                    <div id="contentArea">
                        <!-- Le contenu change ici -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter Technicien -->
    <div class="modal fade" id="addTechModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Nouveau Technicien</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nom complet</label>
                        <input type="text" class="form-control" id="newTechName" placeholder="Jean Dupont">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="newTechEmail" placeholder="technicien@ascenseurs.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-control" id="newTechPassword" placeholder="Mot de passe">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="addTechnicien()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter Document -->
    <div class="modal fade" id="addDocModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-upload"></i> Nouveau Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nom du document</label>
                        <input type="text" class="form-control" id="docName" placeholder="Manuel Kone 2024">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Marque</label>
                        <select class="form-select" id="docBrand">
                            <option value="Kone">Kone</option>
                            <option value="Thyssen">Thyssen</option>
                            <option value="Otis">Otis</option>
                            <option value="Schindler">Schindler</option>
                            <option value="Sodimas">Sodimas</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="docType">
                            <option value="manuel">Manuel technique</option>
                            <option value="schema">Schéma électrique</option>
                            <option value="guide">Guide dépannage</option>
                            <option value="notice">Notice installation</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="addDocument()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // === BASE DE DONNÉES UTILISATEURS ===
        let USERS = JSON.parse(localStorage.getItem('ascenseurs_users')) || [
            { 
                id: 1, 
                email: "admin@ascenseurs.com", 
                password: "Admin2024!", 
                name: "Administrateur Principal", 
                role: "admin",
                dateCreation: new Date().toISOString()
            },
            { 
                id: 2, 
                email: "tech1@ascenseurs.com", 
                password: "Tech123!", 
                name: "Pierre Martin - Kone", 
                role: "technicien",
                specialite: "Kone",
                dateCreation: new Date().toISOString()
            },
            { 
                id: 3, 
                email: "tech2@ascenseurs.com", 
                password: "Tech123!", 
                name: "Marie Dubois - Thyssen", 
                role: "technicien",
                specialite: "Thyssen", 
                dateCreation: new Date().toISOString()
            }
        ];

        // === BASE DE DONNÉES DOCUMENTS ===
        let DOCUMENTS = JSON.parse(localStorage.getItem('ascenseurs_documents')) || [
            {
                id: 1,
                name: "Manuel Kone MonoSpace 2024",
                brand: "Kone",
                type: "manuel",
                addedBy: "admin@ascenseurs.com",
                dateAdded: new Date().toISOString()
            },
            {
                id: 2,
                name: "Schéma Thyssen 3300 Electrique",
                brand: "Thyssen", 
                type: "schema",
                addedBy: "admin@ascenseurs.com",
                dateAdded: new Date().toISOString()
            },
            {
                id: 3,
                name: "Guide Otis Gen2 Maintenance",
                brand: "Otis",
                type: "guide", 
                addedBy: "admin@ascenseurs.com",
                dateAdded: new Date().toISOString()
            }
        ];

        let currentUser = null;
        let DIAGNOSTICS = JSON.parse(localStorage.getItem('ascenseurs_diagnostics')) || [];
        let currentPhoto = null; // Photo temporaire

        // Sauvegarder les données
        function saveData() {
            localStorage.setItem('ascenseurs_users', JSON.stringify(USERS));
            localStorage.setItem('ascenseurs_documents', JSON.stringify(DOCUMENTS));
            localStorage.setItem('ascenseurs_diagnostics', JSON.stringify(DIAGNOSTICS));
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🚀 Application démarrée");
            saveData(); // Sauvegarder les données initiales
            
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                const user = USERS.find(u => u.email === email && u.password === password);
                
                if (user) {
                    currentUser = user;
                    showAppInterface();
                } else {
                    alert('❌ Email ou mot de passe incorrect');
                }
            });
        });

        function showAppInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appInterface').style.display = 'block';
            
            // Afficher/masquer bouton admin
            if (currentUser.role === 'admin') {
                document.getElementById('adminNavBtn').style.display = 'block';
                document.getElementById('userBadge').innerHTML = '<span class="admin-badge">👑 ADMIN</span>';
                document.getElementById('photoNavBtn').style.display = 'none'; // Pas de photo pour admin
            } else {
                document.getElementById('userBadge').innerHTML = '<span class="tech-badge">🔧 TECHNICIEN</span>';
                document.getElementById('photoNavBtn').style.display = 'block'; // Photo pour techniciens
            }
            
            // Afficher infos utilisateur
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').innerHTML = currentUser.role === 'admin' 
                ? '<span class="badge bg-danger">Administrateur</span>'
                : `<span class="badge bg-success">Technicien ${currentUser.specialite || ''}</span>`;
            
            showSection('accueil');
        }

        function showSection(section) {
            const contentArea = document.getElementById('contentArea');
            
            // Mettre à jour les boutons actifs
            document.querySelectorAll('.list-group-item').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let html = '';
            
            switch(section) {
                case 'accueil':
                    html = getHomeContent();
                    break;
                case 'documents':
                    html = getDocumentsContent();
                    break;
                case 'diagnostic':
                    html = getDiagnosticContent();
                    break;
                case 'admin':
                    if(currentUser.role === 'admin') {
                        html = getAdminContent();
                    }
                    break;
                case 'photo':
                    if(currentUser.role === 'technicien') {
                        html = getPhotoContent();
                    }
                    break;
            }
            
            contentArea.innerHTML = html;
        }

        function getHomeContent() {
            return `
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4><i class="fas fa-home"></i> Tableau de Bord</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h5>Bienvenue ${currentUser.name} !</h5>
                            <p>Votre assistant IA pour le dépannage d'ascenseurs</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-users fa-2x text-primary"></i>
                                        <h5 class="mt-2">${USERS.length}</h5>
                                        <p>Utilisateurs</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-file-pdf fa-2x text-danger"></i>
                                        <h5 class="mt-2">${DOCUMENTS.length}</h5>
                                        <p>Documents</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-stethoscope fa-2x text-warning"></i>
                                        <h5 class="mt-2">${DIAGNOSTICS.length}</h5>
                                        <p>Diagnostics</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-camera fa-2x text-success"></i>
                                        <h5 class="mt-2">Photo</h5>
                                        <p>Outils tech</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getDocumentsContent() {
            let documentsHTML = DOCUMENTS.map(doc => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${doc.name}</h6>
                                <span class="badge bg-primary">${doc.brand}</span>
                                <span class="badge bg-secondary">${doc.type}</span>
                                <small class="text-muted d-block mt-1">
                                    Ajouté par ${doc.addedBy} • ${new Date(doc.dateAdded).toLocaleDateString()}
                                </small>
                            </div>
                            ${currentUser.role === 'admin' ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument(${doc.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="card">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-folder"></i> Documents IA</h4>
                        ${currentUser.role === 'admin' ? `
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addDocModal">
                            <i class="fas fa-plus"></i> Nouveau
                        </button>
                        ` : ''}
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <p>Base de connaissances pour l'intelligence artificielle</p>
                        </div>
                        ${documentsHTML || '<p class="text-muted">Aucun document</p>'}
                    </div>
                </div>
            `;
        }

        function getDiagnosticContent() {
            return `
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="fas fa-stethoscope"></i> Diagnostic IA</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Description de la panne</label>
                            <textarea class="form-control" id="problemDesc" rows="4" 
                                      placeholder="Décrivez le problème en détail..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Marque concernée</label>
                            <select class="form-select" id="problemBrand">
                                <option value="Kone">Kone</option>
                                <option value="Thyssen">Thyssen</option>
                                <option value="Otis">Otis</option>
                                <option value="Schindler">Schindler</option>
                            </select>
                        </div>

                        ${currentUser.role === 'technicien' ? `
                        <div class="mb-3">
                            <label class="form-label">Photo de l'équipement (optionnel)</label>
                            <div class="photo-warning">
                                <small><i class="fas fa-info-circle"></i> Les photos ne sont pas sauvegardées et seront supprimées à la fermeture de la session</small>
                            </div>
                            <div id="currentPhotoPreview"></div>
                            <button class="btn btn-info btn-sm mt-2" onclick="showSection('photo')">
                                <i class="fas fa-camera"></i> Prendre une photo
                            </button>
                        </div>
                        ` : ''}
                        
                        <button class="btn btn-warning w-100" onclick="analyserPanne()">
                            <i class="fas fa-robot"></i> Analyser avec l'IA
                        </button>
                        
                        <div id="resultatIA" class="mt-3"></div>
                    </div>
                </div>
            `;
        }

        function getPhotoContent() {
            return `
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h4><i class="fas fa-camera"></i> Capture Photo - Technicien</h4>
                    </div>
                    <div class="card-body">
                        <div class="photo-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Attention :</strong> Les photos ne sont PAS sauvegardées et seront perdues à la fermeture de l'application. 
                            Utilisez-les uniquement pour l'analyse immédiate.
                        </div>

                        <div class="camera-container text-center">
                            <div class="mb-3">
                                <select class="form-select" id="photoType">
                                    <option value="armoire">Armoire électrique</option>
                                    <option value="schema">Schéma technique</option>
                                    <option value="tube">Tube de manœuvre</option>
                                    <option value="composant">Composant défectueux</option>
                                    <option value="autre">Autre équipement</option>
                                </select>
                            </div>

                            <video id="cameraPreview" autoplay playsinline></video>
                            
                            <div class="photo-capture-buttons">
                                <button class="btn btn-success" onclick="capturePhoto()" id="captureBtn">
                                    <i class="fas fa-camera"></i> Prendre la photo
                                </button>
                                <button class="btn btn-secondary" onclick="stopCamera()">
                                    <i class="fas fa-stop"></i> Arrêter caméra
                                </button>
                            </div>

                            <div id="capturedPhotoContainer" class="mt-3" style="display: none;">
                                <h6>Photo capturée :</h6>
                                <img id="capturedPhoto" class="captured-photo">
                                <div class="mt-2">
                                    <button class="btn btn-primary btn-sm" onclick="useThisPhoto()">
                                        <i class="fas fa-check"></i> Utiliser cette photo
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="retakePhoto()">
                                        <i class="fas fa-redo"></i> Reprendre
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="analyzePhoto()">
                                        <i class="fas fa-search"></i> Analyser la photo
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h5>Dernières photos (temporaires) :</h5>
                            <div id="recentPhotos" class="d-flex flex-wrap gap-2">
                                <!-- Les photos récentes apparaîtront ici -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getAdminContent() {
            let techniciensHTML = USERS.filter(user => user.role === 'technicien')
                .map(tech => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${tech.name}</h6>
                                    <p class="mb-1 text-muted">${tech.email}</p>
                                    <span class="badge bg-success">${tech.specialite || 'Général'}</span>
                                    <small class="text-muted">
                                        Créé le ${new Date(tech.dateCreation).toLocaleDateString()}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTechnicien(${tech.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            
            return `
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h4><i class="fas fa-crown"></i> Espace Administrateur</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Gestion des Techniciens</h5>
                                    </div>
                                    <div class="card-body">
                                        ${techniciensHTML || '<p class="text-muted">Aucun technicien</p>'}
                                        <button class="btn btn-success w-100 mt-3" data-bs-toggle="modal" data-bs-target="#addTechModal">
                                            <i class="fas fa-user-plus"></i> Ajouter un technicien
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Statistiques</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Utilisateurs total:</strong> ${USERS.length}</p>
                                        <p><strong>Techniciens:</strong> ${USERS.filter(u => u.role === 'technicien').length}</p>
                                        <p><strong>Documents IA:</strong> ${DOCUMENTS.length}</p>
                                        <p><strong>Diagnostics:</strong> ${DIAGNOSTICS.length}</p>
                                        <hr>
                                        <p class="text-success"><strong>IA Active:</strong> ✅ Opérationnelle</p>
                                        <p class="text-info"><strong>Module Photo:</strong> ✅ Techniciens uniquement</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // === FONCTIONS CAMÉRA ET PHOTO ===
        let cameraStream = null;
        let capturedPhotoData = null;

        function startCamera() {
            const video = document.getElementById('cameraPreview');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        cameraStream = stream;
                        video.srcObject = stream;
                    })
                    .catch(function(error) {
                        console.error("Erreur caméra:", error);
                        alert("Impossible d'accéder à la caméra. Vérifiez les permissions.");
                    });
            } else {
                alert("Votre navigateur ne supporte pas l'accès à la caméra.");
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            const video = document.getElementById('cameraPreview');
            video.srcObject = null;
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedPhotoData = canvas.toDataURL('image/jpeg');
            
            // Afficher la photo capturée
            document.getElementById('capturedPhoto').src = capturedPhotoData;
            document.getElementById('capturedPhotoContainer').style.display = 'block';
            
            // Arrêter la caméra après capture
            stopCamera();
        }

        function useThisPhoto() {
            if (capturedPhotoData) {
                currentPhoto = capturedPhotoData;
                
                // Mettre à jour l'aperçu dans la section diagnostic
                const photoPreview = document.getElementById('currentPhotoPreview');
                if (photoPreview) {
                    photoPreview.innerHTML = `
                        <img src="${capturedPhotoData}" class="captured-photo" style="max-width: 200px;">
                        <div class="mt-1">
                            <small class="text-success">Photo ajoutée au diagnostic</small>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removePhoto()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }
                
                // Ajouter aux photos récentes
                addToRecentPhotos(capturedPhotoData);
                
                alert("✅ Photo ajoutée au diagnostic actuel !");
                showSection('diagnostic');
            }
        }

        function retakePhoto() {
            capturedPhotoData = null;
            document.getElementById('capturedPhotoContainer').style.display = 'none';
            startCamera();
        }

        function analyzePhoto() {
            if (!capturedPhotoData) {
                alert("Aucune photo à analyser");
                return;
            }
            
            const photoType = document.getElementById('photoType').value;
            let analysis = "";
            
            switch(photoType) {
                case 'armoire':
                    analysis = "🔍 Analyse de l'armoire électrique : Vérifiez les contacteurs, relais et fusibles. Contrôlez la tension d'alimentation.";
                    break;
                case 'schema':
                    analysis = "🔍 Analyse du schéma : Recherche des composants critiques. Vérifiez les connections et les repères techniques.";
                    break;
                case 'tube':
                    analysis = "🔍 Analyse du tube de manœuvre : Inspection des connections et de l'état général. Vérifiez l'étanchéité.";
                    break;
                case 'composant':
                    analysis = "🔍 Analyse du composant : Identification en cours. Comparez avec les références techniques disponibles.";
                    break;
                default:
                    analysis = "🔍 Analyse générale : L'IA examine l'image pour identifier les éléments techniques pertinents.";
            }
            
            alert(`🧠 ANALYSE IA PHOTO :\n\n${analysis}\n\nLa photo sera utilisée pour améliorer le diagnostic.`);
        }

        function removePhoto() {
            currentPhoto = null;
            const photoPreview = document.getElementById('currentPhotoPreview');
            if (photoPreview) {
                photoPreview.innerHTML = '';
            }
        }

        function addToRecentPhotos(photoData) {
            const recentPhotos = document.getElementById('recentPhotos');
            if (recentPhotos) {
                const photoId = 'photo_' + Date.now();
                const photoElement = `
                    <div class="position-relative">
                        <img src="${photoData}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;">
                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0" onclick="deleteRecentPhoto('${photoId}')" style="transform: translate(30%, -30%);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                recentPhotos.innerHTML = photoElement + recentPhotos.innerHTML;
                
                // Limiter à 6 photos maximum
                const photos = recentPhotos.querySelectorAll('div');
                if (photos.length > 6) {
                    photos[photos.length - 1].remove();
                }
            }
        }

        function deleteRecentPhoto(photoId) {
            const element = document.querySelector(`[onclick="deleteRecentPhoto('${photoId}')"]`).parentElement;
            if (element) {
                element.remove();
            }
        }

        // Démarrer la caméra quand on arrive sur la section photo
        document.addEventListener('DOMContentLoaded', function() {
            // Redémarrer la caméra quand on montre la section photo
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        const contentArea = document.getElementById('contentArea');
                        if (contentArea.innerHTML.includes('Capture Photo - Technicien')) {
                            setTimeout(startCamera, 500);
                        }
                    }
                });
            });
            
            observer.observe(document.getElementById('contentArea'), {
                childList: true,
                subtree: true
            });
        });

        // === FONCTIONS ADMIN ===

        function addTechnicien() {
            const name = document.getElementById('newTechName').value;
            const email = document.getElementById('newTechEmail').value;
            const password = document.getElementById('newTechPassword').value;
            
            if (!name || !email || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            // Vérifier si l'email existe déjà
            if (USERS.find(u => u.email === email)) {
                alert('Cet email est déjà utilisé');
                return;
            }
            
            const newTech = {
                id: Date.now(),
                name: name,
                email: email,
                password: password,
                role: 'technicien',
                specialite: 'Général',
                dateCreation: new Date().toISOString()
            };
            
            USERS.push(newTech);
            saveData();
            
            // Fermer le modal et réinitialiser
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTechModal'));
            modal.hide();
            document.getElementById('newTechName').value = '';
            document.getElementById('newTechEmail').value = '';
            document.getElementById('newTechPassword').value = '';
            
            // Recharger l'interface admin
            showSection('admin');
            
            alert('✅ Technicien ajouté avec succès !');
        }

        function deleteTechnicien(techId) {
            if (confirm('Supprimer ce technicien ?')) {
                USERS = USERS.filter(user => user.id !== techId);
                saveData();
                showSection('admin');
                alert('✅ Technicien supprimé !');
            }
        }

        function addDocument() {
            const name = document.getElementById('docName').value;
            const brand = document.getElementById('docBrand').value;
            const type = document.getElementById('docType').value;
            
            if (!name) {
                alert('Veuillez donner un nom au document');
                return;
            }
            
            const newDoc = {
                id: Date.now(),
                name: name,
                brand: brand,
                type: type,
                addedBy: currentUser.email,
                dateAdded: new Date().toISOString()
            };
            
            DOCUMENTS.push(newDoc);
            saveData();
            
            // Fermer le modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDocModal'));
            modal.hide();
            document.getElementById('docName').value = '';
            
            // Recharger l'interface documents
            showSection('documents');
            
            alert('✅ Document ajouté à la base IA !');
        }

        function deleteDocument(docId) {
            if (confirm('Supprimer ce document ?')) {
                DOCUMENTS = DOCUMENTS.filter(doc => doc.id !== docId);
                saveData();
                showSection('documents');
                alert('✅ Document supprimé !');
            }
        }

        function analyserPanne() {
            const problem = document.getElementById('problemDesc').value;
            const brand = document.getElementById('problemBrand').value;
            
            if (!problem) {
                alert('Veuillez décrire la panne');
                return;
            }
            
            const resultat = document.getElementById('resultatIA');
            resultat.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> L'IA analyse le problème en consultant sa base de connaissances...
                    ${currentPhoto ? '<div class="mt-2"><i class="fas fa-camera"></i> Photo incluse dans l\'analyse</div>' : ''}
                </div>
            `;
            
            // Simulation analyse IA avec les documents
            setTimeout(() => {
                const relevantDocs = DOCUMENTS.filter(doc => doc.brand === brand);
                let solution = "Vérifier les systèmes de sécurité et les capteurs principaux.";
                
                if (relevantDocs.length > 0) {
                    solution = `Basé sur ${relevantDocs.length} document(s) ${brand}, vérifiez : capteurs de porte, alimentation électrique, et consultez le manuel technique.`;
                }
                
                // Si photo disponible, améliorer l'analyse
                if (currentPhoto) {
                    solution += " 📸 L'analyse de la photo confirme l'importance de vérifier les connections visibles.";
                }
                
                // Enregistrer le diagnostic
                const diagnostic = {
                    id: Date.now(),
                    problem: problem,
                    solution: solution,
                    brand: brand,
                    technicien: currentUser.name,
                    date: new Date().toLocaleString(),
                    resolved: false,
                    hasPhoto: !!currentPhoto
                };
                
                DIAGNOSTICS.push(diagnostic);
                saveData();
                
                resultat.innerHTML = `
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5><i class="fas fa-check-circle"></i> Diagnostic IA Terminé</h5>
                            ${currentPhoto ? '<span class="badge bg-info">📸 Photo analysée</span>' : ''}
                        </div>
                        <div class="card-body">
                            <p><strong>Problème analysé:</strong> ${problem.substring(0, 100)}...</p>
                            <div class="alert alert-warning">
                                <h6>Solution IA recommandée:</h6>
                                <p class="mb-0">${solution}</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success" onclick="markResolved(${diagnostic.id})">
                                    <i class="fas fa-check"></i> Résolu
                                </button>
                                <button class="btn btn-danger" onclick="markNotResolved(${diagnostic.id})">
                                    <i class="fas fa-times"></i> Non résolu
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Réinitialiser la photo après utilisation
                currentPhoto = null;
                const photoPreview = document.getElementById('currentPhotoPreview');
                if (photoPreview) photoPreview.innerHTML = '';
                
            }, 3000);
        }

        function markResolved(diagId) {
            const diagnostic = DIAGNOSTICS.find(d => d.id === diagId);
            if (diagnostic) {
                diagnostic.resolved = true;
                saveData();
                alert('✅ Diagnostic marqué comme résolu ! L\'IA apprend de cette solution.');
            }
        }

        function markNotResolved(diagId) {
            const realSolution = prompt('Quelle était la vraie solution ? L\'IA apprendra de votre réponse:');
            if (realSolution) {
                const diagnostic = DIAGNOSTICS.find(d => d.id === diagId);
                if (diagnostic) {
                    diagnostic.solution = realSolution;
                    diagnostic.resolved = true;
                    saveData();
                    alert('✅ Solution enregistrée ! L\'IA a appris de votre correction.');
                }
            }
        }

        function logout() {
            // Arrêter la caméra avant de se déconnecter
            stopCamera();
            // Supprimer les photos temporaires
            currentPhoto = null;
            capturedPhotoData = null;
            
            if(confirm('Se déconnecter ?')) {
                location.reload();
            }
        }

        console.log("✅ Application avec module photo chargée !");
    </script>
</body>
</html>

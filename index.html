<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant IA Ascenseurs - Photo & Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .login-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 20px;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            margin: 0 auto;
        }
        .app-interface {
            display: none;
        }
        .admin-badge {
            background: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        .tech-badge {
            background: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        .photo-preview {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 10px;
        }
        .camera-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        #cameraView {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
        }
        .password-toggle {
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>
<body>
    <!-- √âcran de connexion -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                <h2>Assistant IA Ascenseurs</h2>
                <p class="text-muted">Espace Admin & Techniciens</p>
            </div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="votre@email.com" required>
                </div>
                
                <div class="mb-3 position-relative">
                    <label class="form-label">Mot de passe</label>
                    <input type="password" class="form-control" id="password" placeholder="Votre mot de passe" required>
                    <span class="password-toggle" onclick="togglePassword()">
                        <i class="fas fa-eye"></i>
                    </span>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="showPassword">
                    <label class="form-check-label" for="showPassword">
                        Afficher le mot de passe
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary w-100 py-2">
                    <i class="fas fa-lock"></i> Se connecter
                </button>
            </form>
            
            <div class="mt-3 text-center">
                <small class="text-muted">
                    Test: admin@ascenseurs.com / Admin2024!
                </small>
            </div>
        </div>
    </div>

    <!-- Interface principale -->
    <div class="app-interface" id="appInterface">
        <nav class="navbar navbar-dark bg-dark">
            <div class="container">
                <span class="navbar-brand">
                    <i class="fas fa-robot"></i> Assistant IA
                    <span id="userBadge" class="ms-2"></span>
                </span>
                <div class="navbar-nav ms-auto">
                    <span class="nav-text text-light me-3">
                        <i class="fas fa-circle text-success"></i> En ligne
                    </span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> D√©co
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row">
                <!-- Navigation -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Navigation
                        </div>
                        <div class="list-group list-group-flush">
                            <button class="list-group-item list-group-item-action active" onclick="showSection('accueil')">
                                <i class="fas fa-home"></i> Accueil
                            </button>
                            <button class="list-group-item list-group-item-action" onclick="showSection('documents')">
                                <i class="fas fa-folder"></i> Documents IA
                            </button>
                            <button class="list-group-item list-group-item-action" onclick="showSection('diagnostic')">
                                <i class="fas fa-stethoscope"></i> Diagnostic
                            </button>
                            <button class="list-group-item list-group-item-action" id="photoNavBtn" style="display:none;" onclick="showSection('photo')">
                                <i class="fas fa-camera"></i> Analyse Photo
                            </button>
                            <button class="list-group-item list-group-item-action" id="adminNavBtn" style="display:none;" onclick="showSection('admin')">
                                <i class="fas fa-crown"></i> Administration
                            </button>
                        </div>
                    </div>
                    
                    <!-- Statut utilisateur -->
                    <div class="card mt-3">
                        <div class="card-body text-center p-3">
                            <h6 id="userName"></h6>
                            <div id="userRole"></div>
                        </div>
                    </div>
                </div>

                <!-- Contenu principal -->
                <div class="col-md-9">
                    <div id="contentArea">
                        <!-- Le contenu change ici -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter Technicien -->
    <div class="modal fade" id="addTechModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Nouveau Technicien</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nom complet</label>
                        <input type="text" class="form-control" id="newTechName" placeholder="Jean Dupont">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="newTechEmail" placeholder="technicien@ascenseurs.com">
                    </div>
                    <div class="mb-3 position-relative">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-control" id="newTechPassword" placeholder="Mot de passe">
                        <span class="password-toggle" onclick="toggleNewTechPassword()">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showNewTechPassword">
                        <label class="form-check-label" for="showNewTechPassword">
                            Afficher le mot de passe
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="addTechnicien()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter Document -->
    <div class="modal fade" id="addDocModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-upload"></i> Nouveau Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nom du document</label>
                        <input type="text" class="form-control" id="docName" placeholder="Manuel Kone 2024">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Marque</label>
                        <select class="form-select" id="docBrand">
                            <option value="Kone">Kone</option>
                            <option value="Thyssen">Thyssen</option>
                            <option value="Otis">Otis</option>
                            <option value="Schindler">Schindler</option>
                            <option value="Sodimas">Sodimas</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="docType">
                            <option value="manuel">Manuel technique</option>
                            <option value="schema">Sch√©ma √©lectrique</option>
                            <option value="guide">Guide d√©pannage</option>
                            <option value="notice">Notice installation</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="addDocument()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // === BASE DE DONN√âES UTILISATEURS ===
        let USERS = JSON.parse(localStorage.getItem('ascenseurs_users')) || [
            { 
                id: 1, 
                email: "admin@ascenseurs.com", 
                password: "Admin2024!", 
                name: "Administrateur Principal", 
                role: "admin",
                dateCreation: new Date().toISOString()
            },
            { 
                id: 2, 
                email: "tech1@ascenseurs.com", 
                password: "Tech123!", 
                name: "Pierre Martin - Kone", 
                role: "technicien",
                specialite: "Kone",
                dateCreation: new Date().toISOString()
            },
            { 
                id: 3, 
                email: "tech2@ascenseurs.com", 
                password: "Tech123!", 
                name: "Marie Dubois - Thyssen", 
                role: "technicien",
                specialite: "Thyssen", 
                dateCreation: new Date().toISOString()
            }
        ];

        // === BASE DE DONN√âES DOCUMENTS ===
        let DOCUMENTS = JSON.parse(localStorage.getItem('ascenseurs_documents')) || [
            {
                id: 1,
                name: "Manuel Kone MonoSpace 2024",
                brand: "Kone",
                type: "manuel",
                addedBy: "admin@ascenseurs.com",
                dateAdded: new Date().toISOString()
            },
            {
                id: 2,
                name: "Sch√©ma Thyssen 3300 Electrique",
                brand: "Thyssen", 
                type: "schema",
                addedBy: "admin@ascenseurs.com",
                dateAdded: new Date().toISOString()
            },
            {
                id: 3,
                name: "Guide Otis Gen2 Maintenance",
                brand: "Otis",
                type: "guide", 
                addedBy: "admin@ascenseurs.com",
                dateAdded: new Date().toISOString()
            }
        ];

        let currentUser = null;
        let DIAGNOSTICS = JSON.parse(localStorage.getItem('ascenseurs_diagnostics')) || [];
        let currentPhoto = null;
        let cameraStream = null;

        // Sauvegarder les donn√©es
        function saveData() {
            localStorage.setItem('ascenseurs_users', JSON.stringify(USERS));
            localStorage.setItem('ascenseurs_documents', JSON.stringify(DOCUMENTS));
            localStorage.setItem('ascenseurs_diagnostics', JSON.stringify(DIAGNOSTICS));
        }

        // Fonction pour afficher/masquer le mot de passe
        function togglePassword() {
            const passwordField = document.getElementById('password');
            const icon = document.querySelector('.password-toggle i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                passwordField.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function toggleNewTechPassword() {
            const passwordField = document.getElementById('newTechPassword');
            const icon = document.querySelector('#addTechModal .password-toggle i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                passwordField.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Gestion de la checkbox
        document.addEventListener('DOMContentLoaded', function() {
            // Checkbox connexion
            document.getElementById('showPassword').addEventListener('change', function() {
                const passwordField = document.getElementById('password');
                passwordField.type = this.checked ? 'text' : 'password';
            });

            // Checkbox modal technicien
            document.getElementById('showNewTechPassword')?.addEventListener('change', function() {
                const passwordField = document.getElementById('newTechPassword');
                passwordField.type = this.checked ? 'text' : 'password';
            });
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Application d√©marr√©e");
            saveData(); // Sauvegarder les donn√©es initiales
            
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                const user = USERS.find(u => u.email === email && u.password === password);
                
                if (user) {
                    currentUser = user;
                    showAppInterface();
                } else {
                    alert('‚ùå Email ou mot de passe incorrect');
                }
            });
        });

        function showAppInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appInterface').style.display = 'block';
            
            // Afficher/masquer boutons selon le r√¥le
            if (currentUser.role === 'admin') {
                document.getElementById('adminNavBtn').style.display = 'block';
                document.getElementById('userBadge').innerHTML = '<span class="admin-badge">üëë ADMIN</span>';
            } else {
                document.getElementById('photoNavBtn').style.display = 'block';
                document.getElementById('userBadge').innerHTML = '<span class="tech-badge">üîß TECHNICIEN</span>';
            }
            
            // Afficher infos utilisateur
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').innerHTML = currentUser.role === 'admin' 
                ? '<span class="badge bg-danger">Administrateur</span>'
                : `<span class="badge bg-success">Technicien ${currentUser.specialite || ''}</span>`;
            
            showSection('accueil');
        }

        function showSection(section) {
            const contentArea = document.getElementById('contentArea');
            
            // Arr√™ter la cam√©ra si elle est active
            if (cameraStream && section !== 'photo') {
                stopCamera();
            }
            
            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.list-group-item').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let html = '';
            
            switch(section) {
                case 'accueil':
                    html = getHomeContent();
                    break;
                case 'documents':
                    html = getDocumentsContent();
                    break;
                case 'diagnostic':
                    html = getDiagnosticContent();
                    break;
                case 'photo':
                    if(currentUser.role === 'technicien') {
                        html = getPhotoContent();
                        // D√©marrer la cam√©ra automatiquement
                        setTimeout(() => initCamera(), 500);
                    }
                    break;
                case 'admin':
                    if(currentUser.role === 'admin') {
                        html = getAdminContent();
                    }
                    break;
            }
            
            contentArea.innerHTML = html;
        }

        function getHomeContent() {
            return `
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4><i class="fas fa-home"></i> Tableau de Bord</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h5>Bienvenue ${currentUser.name} !</h5>
                            <p>Votre assistant IA pour le d√©pannage d'ascenseurs</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-users fa-2x text-primary"></i>
                                        <h5 class="mt-2">${USERS.length}</h5>
                                        <p>Utilisateurs</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-file-pdf fa-2x text-danger"></i>
                                        <h5 class="mt-2">${DOCUMENTS.length}</h5>
                                        <p>Documents</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-stethoscope fa-2x text-warning"></i>
                                        <h5 class="mt-2">${DIAGNOSTICS.length}</h5>
                                        <p>Diagnostics</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-camera fa-2x text-success"></i>
                                        <h5 class="mt-2">Photo</h5>
                                        <p>Analyse IA</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getDocumentsContent() {
            let documentsHTML = DOCUMENTS.map(doc => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${doc.name}</h6>
                                <span class="badge bg-primary">${doc.brand}</span>
                                <span class="badge bg-secondary">${doc.type}</span>
                                <small class="text-muted d-block mt-1">
                                    Ajout√© par ${doc.addedBy} ‚Ä¢ ${new Date(doc.dateAdded).toLocaleDateString()}
                                </small>
                            </div>
                            ${currentUser.role === 'admin' ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument(${doc.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="card">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-folder"></i> Documents IA</h4>
                        ${currentUser.role === 'admin' ? `
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addDocModal">
                            <i class="fas fa-plus"></i> Nouveau
                        </button>
                        ` : ''}
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <p>Base de connaissances pour l'intelligence artificielle</p>
                        </div>
                        ${documentsHTML || '<p class="text-muted">Aucun document</p>'}
                    </div>
                </div>
            `;
        }

        function getDiagnosticContent() {
            return `
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="fas fa-stethoscope"></i> Diagnostic IA</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Description de la panne</label>
                            <textarea class="form-control" id="problemDesc" rows="4" 
                                      placeholder="D√©crivez le probl√®me en d√©tail..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Marque concern√©e</label>
                            <select class="form-select" id="problemBrand">
                                <option value="Kone">Kone</option>
                                <option value="Thyssen">Thyssen</option>
                                <option value="Otis">Otis</option>
                                <option value="Schindler">Schindler</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-warning w-100" onclick="analyserPanne()">
                            <i class="fas fa-robot"></i> Analyser avec l'IA
                        </button>
                        
                        <div id="resultatIA" class="mt-3"></div>
                    </div>
                </div>
            `;
        }

        function getPhotoContent() {
            return `
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h4><i class="fas fa-camera"></i> Analyse Photo - Technicien</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-info-circle"></i> Utilisation de l'appareil photo</h6>
                            <p class="mb-2">Prenez une photo de :</p>
                            <ul class="mb-0">
                                <li>Sch√©mas √©lectriques</li>
                                <li>Armoires de commande</li>
                                <li>Plaques signal√©tiques</li>
                                <li>Composants suspects</li>
                            </ul>
                        </div>
                        
                        <div class="camera-container mb-3">
                            <video id="cameraView" autoplay playsinline></video>
                            <div class="camera-controls">
                                <button class="btn btn-success btn-lg" onclick="takePhoto()">
                                    <i class="fas fa-camera"></i> Prendre une photo
                                </button>
                            </div>
                        </div>
                        
                        <div id="photoResult" class="mt-3"></div>
                        
                        <div class="mt-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="stopCamera()">
                                <i class="fas fa-stop"></i> Arr√™ter la cam√©ra
                            </button>
                            <button class="btn btn-outline-info btn-sm ms-2" onclick="initCamera()">
                                <i class="fas fa-sync"></i> Red√©marrer
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getAdminContent() {
            let techniciensHTML = USERS.filter(user => user.role === 'technicien')
                .map(tech => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${tech.name}</h6>
                                    <p class="mb-1 text-muted">${tech.email}</p>
                                    <span class="badge bg-success">${tech.specialite || 'G√©n√©ral'}</span>
                                    <small class="text-muted">
                                        Cr√©√© le ${new Date(tech.dateCreation).toLocaleDateString()}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTechnicien(${tech.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            
            return `
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h4><i class="fas fa-crown"></i> Espace Administrateur</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Gestion des Techniciens</h5>
                                    </div>
                                    <div class="card-body">
                                        ${techniciensHTML || '<p class="text-muted">Aucun technicien</p>'}
                                        <button class="btn btn-success w-100 mt-3" data-bs-toggle="modal" data-bs-target="#addTechModal">
                                            <i class="fas fa-user-plus"></i> Ajouter un technicien
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Statistiques</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Utilisateurs total:</strong> ${USERS.length}</p>
                                        <p><strong>Techniciens:</strong> ${USERS.filter(u => u.role === 'technicien').length}</p>
                                        <p><strong>Documents IA:</strong> ${DOCUMENTS.length}</p>
                                        <p><strong>Diagnostics:</strong> ${DIAGNOSTICS.length}</p>
                                        <hr>
                                        <p class="text-success"><strong>IA Active:</strong> ‚úÖ Op√©rationnelle</p>
                                        <p class="text-info"><strong>Module Photo:</strong> ‚úÖ Disponible techniciens</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // === FONCTIONS APPAREIL PHOTO ===

        async function initCamera() {
            try {
                stopCamera(); // Arr√™ter d'abord si d√©j√† en cours
                
                const video = document.getElementById('cameraView');
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Cam√©ra arri√®re
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                video.srcObject = cameraStream;
                document.getElementById('photoResult').innerHTML = '';
                
            } catch (error) {
                console.error('Erreur cam√©ra:', error);
                document.getElementById('photoResult').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Erreur cam√©ra</h6>
                        <p class="mb-0">Impossible d'acc√©der √† la cam√©ra. V√©rifiez les permissions.</p>
                    </div>
                `;
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            const video = document.getElementById('cameraView');
            if (video) {
                video.srcObject = null;
            }
        }

        function takePhoto() {
            const video = document.getElementById('cameraView');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            currentPhoto = canvas.toDataURL('image/jpeg');
            
            // Afficher la photo et l'analyse
            document.getElementById('photoResult').innerHTML = `
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-check-circle"></i> Photo captur√©e</h5>
                    </div>
                    <div class="card-body">
                        <img src="${currentPhoto}" class="photo-preview" alt="Photo captur√©e">
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> L'IA analyse la photo...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Simulation analyse IA de la photo
            setTimeout(() => {
                analyzePhoto();
            }, 3000);
        }

        function analyzePhoto() {
            const analyses = [
                "üîÑ Analyse des composants √©lectroniques... Sch√©ma d√©tect√© : armoire de commande principale",
                "üìä Identification des connecteurs... Syst√®me de s√©curit√© Kone reconnu",
                "üîç D√©tection des c√¢blages... V√©rifiez les connexions du module de puissance",
                "‚ö° Analyse √©lectrique... Contr√¥lez les fusibles et relais principaux"
            ];
            
            const randomAnalysis = analyses[Math.floor(Math.random() * analyses.length)];
            
            document.querySelector('#photoResult .alert').innerHTML = `
                <h6><i class="fas fa-brain"></i> Analyse IA Termin√©e</h6>
                <p class="mb-2"><strong>R√©sultat :</strong> ${randomAnalysis}</p>
                <p class="mb-0"><small>La photo sera automatiquement supprim√©e apr√®s utilisation</small></p>
            `;
            
            document.querySelector('#photoResult .alert').className = 'alert alert-success';
            
            // Supprimer automatiquement la photo apr√®s 2 minutes
            setTimeout(() => {
                if (document.getElementById('photoResult')) {
                    currentPhoto = null;
                    document.getElementById('photoResult').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-trash"></i> Photo supprim√©e automatiquement
                        </div>
                    `;
                }
            }, 120000); // 2 minutes
        }

        // === FONCTIONS ADMIN ===

        function addTechnicien() {
            const name = document.getElementById('newTechName').value;
            const email = document.getElementById('newTechEmail').value;
            const password = document.getElementById('newTechPassword').value;
            
            if (!name || !email || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            // V√©rifier si l'email existe d√©j√†
            if (USERS.find(u => u.email === email)) {
                alert('Cet email est d√©j√† utilis√©');
                return;
            }
            
            const newTech = {
                id: Date.now(),
                name: name,
                email: email,
                password: password,
                role: 'technicien',
                specialite: 'G√©n√©ral',
                dateCreation: new Date().toISOString()
            };
            
            USERS.push(newTech);
            saveData();
            
            // Fermer le modal et r√©initialiser
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTechModal'));
            modal.hide();
            document.getElementById('newTechName').value = '';
            document.getElementById('newTechEmail').value = '';
            document.getElementById('newTechPassword').value = '';
            
            // Recharger l'interface admin
            showSection('admin');
            
            alert('‚úÖ Technicien ajout√© avec succ√®s !');
        }

        function deleteTechnicien(techId) {
            if (confirm('Supprimer ce technicien ?')) {
                USERS = USERS.filter(user => user.id !== techId);
                saveData();
                showSection('admin');
                alert('‚úÖ Technicien supprim√© !');
            }
        }

        function addDocument() {
            const name = document.getElementById('docName').value;
            const brand = document.getElementById('docBrand').value;
            const type = document.getElementById('docType').value;
            
            if (!name) {
                alert('Veuillez donner un nom au document');
                return;
            }
            
            const newDoc = {
                id: Date.now(),
                name: name,
                brand: brand,
                type: type,
                addedBy: currentUser.email,
                dateAdded: new Date().toISOString()
            };
            
            DOCUMENTS.push(newDoc);
            saveData();
            
            // Fermer le modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDocModal'));
            modal.hide();
            document.getElementById('docName').value = '';
            
            // Recharger l'interface documents
            showSection('documents');
            
            alert('‚úÖ Document ajout√© √† la base IA !');
        }

        function deleteDocument(docId) {
            if (confirm('Supprimer ce document ?')) {
                DOCUMENTS = DOCUMENTS.filter(doc => doc.id !== docId);
                saveData();
                showSection('documents');
                alert('‚úÖ Document supprim√© !');
            }
        }

        function analyserPanne() {
            const problem = document.getElementById('problemDesc').value;
            const brand = document.getElementById('problemBrand').value;
            
            if (!problem) {
                alert('Veuillez d√©crire la panne');
                return;
            }
            
            const resultat = document.getElementById('resultatIA');
            resultat.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> L'IA analyse le probl√®me en consultant sa base de connaissances...
                </div>
            `;
            
            // Simulation analyse IA avec les documents
            setTimeout(() => {
                const relevantDocs = DOCUMENTS.filter(doc => doc.brand === brand);
                let solution = "V√©rifier les syst√®mes de s√©curit√© et les capteurs principaux.";
                
                if (relevantDocs.length > 0) {
                    solution = `Bas√© sur ${relevantDocs.length} document(s) ${brand}, v√©rifiez : capteurs de porte, alimentation √©lectrique, et consultez le manuel technique.`;
                }
                
                // Enregistrer le diagnostic
                const diagnostic = {
                    id: Date.now(),
                    problem: problem,
                    solution: solution,
                    brand: brand,
                    technicien: currentUser.name,
                    date: new Date().toLocaleString(),
                    resolved: false
                };
                
                DIAGNOSTICS.push(diagnostic);
                saveData();
                
                resultat.innerHTML = `
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5><i class="fas fa-check-circle"></i> Diagnostic IA Termin√©</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Probl√®me analys√©:</strong> ${problem.substring(0, 100)}...</p>
                            <div class="alert alert-warning">
                                <h6>Solution IA recommand√©e:</h6>
                                <p class="mb-0">${solution}</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success" onclick="markResolved(${diagnostic.id})">
                                    <i class="fas fa-check"></i> R√©solu
                                </button>
                                <button class="btn btn-danger" onclick="markNotResolved(${diagnostic.id})">
                                    <i class="fas fa-times"></i> Non r√©solu
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }, 3000);
        }

        function markResolved(diagId) {
            const diagnostic = DIAGNOSTICS.find(d => d.id === diagId);
            if (diagnostic) {
                diagnostic.resolved = true;
                saveData();
                alert('‚úÖ Diagnostic marqu√© comme r√©solu ! L\'IA apprend de cette solution.');
            }
        }

        function markNotResolved(diagId) {
            const realSolution = prompt('Quelle √©tait la vraie solution ? L\'IA apprendra de votre r√©ponse:');
            if (realSolution) {
                const diagnostic = DIAGNOSTICS.find(d => d.id === diagId);
                if (diagnostic) {
                    diagnostic.solution = realSolution;
                    diagnostic.resolved = true;
                    saveData();
                    alert('‚úÖ Solution enregistr√©e ! L\'IA a appris de votre correction.');
                }
            }
        }

        function logout() {
            // Arr√™ter la cam√©ra avant de se d√©connecter
            stopCamera();
            if(confirm('Se d√©connecter ?')) {
                location.reload();
            }
        }

        console.log("‚úÖ Application Photo & Admin IA charg√©e !");
    </script>
</body>
</html>
